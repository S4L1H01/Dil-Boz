<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dil-Boz | Pastel Kaos</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* PASTEL BOYAL ARKA PLAN */
        body { 
            background: #87CEEB; /* GÃ¶kyÃ¼zÃ¼ */
            margin: 0; overflow: hidden; font-family: 'Comic Sans MS', cursive;
            display: flex; justify-content: center; align-items: center; height: 100vh;
        }
        .landscape { position: fixed; bottom: 0; width: 100%; height: 300px; z-index: -1; }
        .grass { background: #7CFC00; height: 100px; position: absolute; bottom: 0; width: 100%; border-top: 5px solid #64cc00; }
        .house { position: absolute; bottom: 80px; left: 10%; width: 120px; height: 100px; background: #FFD700; border: 3px solid #333; }
        .roof { position: absolute; bottom: 180px; left: 9%; border-left: 70px solid transparent; border-right: 70px solid transparent; border-bottom: 60px solid #FF4500; }
        .tree { position: absolute; bottom: 80px; right: 15%; width: 20px; height: 100px; background: #8B4513; }
        .leaves { position: absolute; bottom: 160px; right: 12%; width: 80px; height: 80px; background: #228B22; border-radius: 50%; box-shadow: 20px -10px #228B22, -20px -10px #228B22; }

        .panel { background: rgba(255, 255, 255, 0.9); width: 90%; max-width: 500px; min-height: 70vh; border-radius: 25px; border: 8px solid #FF69B4; display: flex; flex-direction: column; box-shadow: 10px 10px 0px rgba(0,0,0,0.1); }
        .header { padding: 15px; background: #FF69B4; color: white; text-align: center; font-size: 1.8rem; }
        .content { flex: 1; padding: 20px; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .active { display: flex; }
        
        #lobby-area { width: 100%; height: 200px; background: rgba(255,255,255,0.5); border-radius: 15px; position: relative; margin: 10px 0; border: 3px dashed #FF69B4; overflow: hidden; }
        .player-bubble { position: absolute; padding: 8px 15px; background: #00BFFF; color: white; border-radius: 20px; cursor: move; font-weight: bold; border: 2px solid white; touch-action: none; }

        input { padding: 15px; border-radius: 12px; border: 3px solid #00BFFF; width: 80%; margin-bottom: 10px; font-size: 1rem; }
        button { padding: 12px 25px; border-radius: 12px; border: none; cursor: pointer; font-weight: bold; color: white; margin: 5px; font-size: 1rem; }
        .btn-green { background: #32CD32; }
        .btn-blue { background: #1E90FF; }
        .btn-red { background: #FF4500; }

        .word-box { background: #FFF; padding: 20px; border-radius: 15px; font-size: 1.5rem; color: #333; border: 4px solid #1E90FF; width: 85%; text-align: center; }
        .results { text-align: left; width: 100%; overflow-y: auto; max-height: 300px; }
        .res-item { background: #eee; margin: 5px 0; padding: 10px; border-radius: 8px; border-left: 5px solid #FF69B4; }
    </style>
</head>
<body>

<div class="landscape">
    <div class="grass"></div>
    <div class="roof"></div>
    <div class="house"></div>
    <div class="tree"></div>
    <div class="leaves"></div>
</div>

<div class="panel">
    <div class="header">DÄ°L-BOZ ðŸŒ€</div>

    <div id="scr-login" class="content active">
        <input type="text" id="nick" placeholder="Ä°smin nedir?">
        <button class="btn-green" onclick="setup('host')">Lobi Kur</button>
        <button class="btn-blue" onclick="document.getElementById('join-box').style.display='block'">Odaya KatÄ±l</button>
        <div id="join-box" style="display:none;">
            <input type="text" id="room-id" placeholder="Kod">
            <button class="btn-blue" onclick="setup('join')">GiriÅŸ</button>
        </div>
    </div>

    <div id="scr-lobby" class="content">
        <p>Oda Kodu: <b id="my-id" style="color:#FF4500">...</b></p>
        <div id="lobby-area"></div>
        <button id="start-btn" class="btn-green" style="display:none" onclick="startGame()">OYUNU BAÅžLAT!</button>
    </div>

    <div id="scr-game" class="content">
        <h3 id="turn-msg" style="color:#FF4500">HazÄ±rlan...</h3>
        <div class="word-box" id="word-display">...</div>
        <input type="text" id="game-input" placeholder="AnladÄ±ÄŸÄ±nÄ± buraya yaz..." disabled>
        <button id="send-btn" class="btn-green" onclick="sendTurn()" disabled>GÃ–NDER</button>
    </div>

    <div id="scr-final" class="content">
        <h2>Oyun Bitti! ðŸŽ¨</h2>
        <div class="results" id="final-results"></div>
        <button class="btn-red" onclick="location.reload()">Tekrar Oyna</button>
    </div>
</div>

<script>
    let peer, conn, myId, myNick, players = [], turnIdx = 0, maxTurns = 5, history = [];
    const symbols = ['$', '#', '/', '!', '?', '@', '*', '%'];
    const foreign = ['Morning', 'Schule', 'Chat', 'Water', 'Livre', 'Friend'];
    const charMap = {'a':'Î±','e':'â‚¬','u':'Î¼','Ã¼':'Ï‹','s':'Â§','ÅŸ':'âˆ«','o':'0','Ã¶':'Î¸','i':'Ä±'};

    function setup(mode) {
        myNick = document.getElementById('nick').value || "Anonim";
        const shortId = Math.random().toString(36).substring(2, 8).toUpperCase();
        peer = new Peer(mode === 'host' ? shortId : undefined);
        peer.on('open', id => {
            myId = id; document.getElementById('my-id').innerText = id;
            show('scr-lobby'); addBubble(id, myNick, true);
            players.push({id: id, nick: myNick});
            if(mode === 'join') {
                conn = peer.connect(document.getElementById('room-id').value.toUpperCase());
                handleConn();
            }
        });
        peer.on('connection', c => { conn = c; handleConn(); document.getElementById('start-btn').style.display='block'; });
    }

    function handleConn() {
        conn.on('open', () => conn.send({type:'join', nick:myNick, id:myId}));
        conn.on('data', d => {
            if(d.type === 'join') { players.push({id:d.id, nick:d.nick}); addBubble(d.id, d.nick, false); if(players.length > 1) conn.send({type:'list', list:players}); }
            if(d.type === 'list') { d.list.forEach(p => { if(!players.find(x=>x.id==p.id)) { players.push(p); addBubble(p.id, p.nick, false); }}); }
            if(d.type === 'move') { let b = document.getElementById('bub-'+d.id); if(b){b.style.left=d.x; b.style.top=d.y;} }
            if(d.type === 'start') { players = d.players; show('scr-game'); nextTurn(); }
            if(d.type === 'play') { history.push({nick: d.nick, text: d.text}); receiveTurn(d.text); }
            if(d.type === 'finish') { history = d.history; showResults(); }
        });
    }

    function addBubble(id, nick, isMe) {
        if(document.getElementById('bub-'+id)) return;
        const b = document.createElement('div');
        b.id = 'bub-'+id; b.className = 'player-bubble'; b.innerText = nick;
        b.style.left = "20px"; b.style.top = "20px";
        if(isMe) makeDraggable(b, id);
        document.getElementById('lobby-area').appendChild(b);
    }

    function makeDraggable(el, id) {
        const area = document.getElementById('lobby-area');
        const move = (e) => {
            const cx = e.touches ? e.touches[0].clientX : e.clientX;
            const cy = e.touches ? e.touches[0].clientY : e.clientY;
            const r = area.getBoundingClientRect();
            let x = cx - r.left - 30, y = cy - r.top - 15;
            if(x<0) x=0; if(x > r.width-70) x=r.width-70;
            if(y<0) y=0; if(y > r.height-40) y=r.height-40;
            el.style.left = x+"px"; el.style.top = y+"px";
            if(conn) conn.send({type:'move', id:id, x:el.style.left, y:el.style.top});
        };
        el.addEventListener('mousedown', () => document.addEventListener('mousemove', move));
        el.addEventListener('touchstart', () => document.addEventListener('touchmove', move));
        document.addEventListener('mouseup', () => document.removeEventListener('mousemove', move));
        document.addEventListener('touchend', () => document.removeEventListener('touchmove', move));
    }

    function startGame() {
        players.sort(() => Math.random() - 0.5);
        conn.send({type:'start', players:players});
        show('scr-game'); nextTurn();
    }

    function nextTurn() {
        if(turnIdx >= maxTurns) {
            if(conn) conn.send({type:'finish', history: history});
            showResults(); return;
        }
        let current = players[turnIdx % players.length];
        document.getElementById('turn-msg').innerText = (current.id === myId ? "SIRA SENDE!" : "BEKLE...");
        document.getElementById('game-input').disabled = current.id !== myId;
        document.getElementById('send-btn').disabled = current.id !== myId;
        if(current.id !== myId) document.getElementById('word-display').innerText = "ArkadaÅŸÄ±n yazÄ±yor...";
    }

    function sendTurn() {
        const val = document.getElementById('game-input').value;
        if(!val) return;
        history.push({nick: myNick, text: val});
        conn.send({type:'play', text:val, nick: myNick});
        document.getElementById('game-input').value = "";
        turnIdx++; nextTurn();
    }

    function receiveTurn(t) {
        let words = t.split(' ');
        let corrupted = words.map(w => {
            if(Math.random() > 0.7) return foreign[Math.floor(Math.random()*foreign.length)];
            let chars = w.split('').map(c => {
                if(charMap[c.toLowerCase()] && Math.random() > 0.4) return charMap[c.toLowerCase()];
                if(Math.random() > 0.8) return symbols[Math.floor(Math.random()*symbols.length)];
                return c;
            });
            return chars.join('');
        }).join(' ');
        document.getElementById('word-display').innerText = corrupted;
        turnIdx++; nextTurn();
    }

    function showResults() {
        show('scr-final');
        const resDiv = document.getElementById('final-results');
        resDiv.innerHTML = history.map((h, i) => `<div class="res-item"><b>${i+1}. ${h.nick}:</b> ${h.text}</div>`).join('');
    }

    function show(id) { document.querySelectorAll('.content').forEach(c=>c.classList.remove('active')); document.getElementById(id).classList.add('active'); }
</script>
</body>
</html>