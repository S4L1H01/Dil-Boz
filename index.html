<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dƒ∞L-BOZ | v6 Ultimate</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #F0F4F8; --primary: #6E7BFF; --secondary: #FF85A1; --accent: #FFD166; --text: #2D3436; --success: #00B894; }
        body { background: var(--bg); margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; transition: background 0.3s; }
        .bg-pattern { position: fixed; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.3; background-image: radial-gradient(#6e7bff 0.5px, transparent 0.5px), radial-gradient(#6e7bff 0.5px, #e5e5f7 0.5px); background-size: 20px 20px; z-index: -1; }
        .panel { background: white; width: 95%; max-width: 800px; min-height: 85vh; border-radius: 40px; border: 12px solid white; display: flex; flex-direction: column; box-shadow: 0 20px 40px rgba(0,0,0,0.1); position: relative; }
        .header { padding: 15px; background: var(--primary); color: white; text-align: center; font-size: 1.6rem; font-weight: bold; border-radius: 25px 25px 5px 5px; }
        .content { flex: 1; padding: 20px; display: none; flex-direction: column; align-items: center; overflow-y: auto; }
        .active { display: flex; }
        
        #lobby-container { display: flex; width: 100%; gap: 15px; flex-wrap: wrap; }
        #lobby-area { flex: 2; height: 350px; background: #F8FAFC; border-radius: 30px; position: relative; border: 4px dashed #CBD5E1; overflow: hidden; min-width: 300px; }
        #wardrobe { flex: 1; background: #FFF9F0; border-radius: 20px; padding: 10px; border: 2px solid var(--accent); overflow-y: auto; max-height: 350px; }
        
        .player-bubble { position: absolute; padding: 12px 22px; background: var(--secondary); color: white; border-radius: 50px; cursor: grab; font-weight: bold; border: 3px solid white; white-space: nowrap; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .acc { position: absolute; pointer-events: none; font-size: 30px; left: 50%; transform: translateX(-50%); z-index: 10; }
        .hat { top: -35px; } .glass { top: -10px; font-size: 22px; } .mustache { bottom: -18px; }
        
        .wardrobe-sec { margin-bottom: 10px; }
        .wardrobe-title { font-size: 0.7rem; font-weight: bold; color: #d35400; margin-bottom: 5px; border-bottom: 1px solid #ffeaa7; }
        .acc-option { font-size: 20px; cursor: pointer; padding: 4px; border-radius: 8px; border: 1px solid #ddd; margin: 2px; display: inline-block; background: white; transition: 0.2s; }
        .acc-option:hover { transform: scale(1.1); background: var(--accent); }
        
        #timer { font-size: 2.5rem; font-weight: bold; color: var(--secondary); }
        .word-box { background: #F1F2F6; padding: 25px; border-radius: 25px; font-size: 1.3rem; border: 4px solid var(--accent); width: 85%; text-align: center; margin: 15px 0; min-height: 60px; word-wrap: break-word; }
        .panic { background-color: #ffcccc !important; }
        
        button { padding: 12px 25px; border-radius: 15px; border: none; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; margin: 5px; }
        .btn-green { background: var(--success); } .btn-blue { background: var(--primary); } .btn-red { background: #FF7675; }
        .btn-large { width: 95%; font-size: 1.4rem; padding: 20px; box-shadow: 0 5px 0 #218c74; }
        .btn-large:active { transform: translateY(3px); box-shadow: none; }
        input, select { padding: 12px; border-radius: 15px; border: 2px solid #ddd; margin: 5px; outline: none; }
    </style>
</head>
<body>
<div class="bg-pattern"></div>
<div class="panel">
    <div class="header">Dƒ∞L-BOZ üåÄ</div>
    
    <div id="scr-login" class="content active">
        <input type="text" id="nick" placeholder="Adƒ±n...">
        <button class="btn-green" onclick="setup('host')">Oda Kur</button>
        <button class="btn-blue" onclick="document.getElementById('join-box').style.display='block'">Katƒ±l</button>
        <div id="join-box" style="display:none; margin-top:10px;">
            <input type="text" id="room-id" placeholder="Kod">
            <button class="btn-blue" onclick="setup('join')">Giri≈ü</button>
        </div>
    </div>

    <div id="scr-lobby" class="content">
        <p>Kod: <b id="my-id" style="color:var(--primary); cursor:pointer">...</b></p>
        <div id="lobby-container">
            <div id="lobby-area"></div>
            <div id="wardrobe">
                <div class="wardrobe-sec">
                    <div class="wardrobe-title">≈ûAPKALAR</div>
                    <div class="acc-option" onclick="setAcc('hat', 'üé©')">üé©</div>
                    <div class="acc-option" onclick="setAcc('hat', 'üëë')">üëë</div>
                    <div class="acc-option" onclick="setAcc('hat', 'üí©')">üí©</div>
                    <div class="acc-option" onclick="setAcc('hat', 'üéì')">üéì</div>
                    <div class="acc-option" onclick="setAcc('hat', '')">‚ùå</div>
                </div>
                <div class="wardrobe-sec">
                    <div class="wardrobe-title">G√ñZL√úKLER</div>
                    <div class="acc-option" onclick="setAcc('gls', 'üï∂Ô∏è')">üï∂Ô∏è</div>
                    <div class="acc-option" onclick="setAcc('gls', 'üòé')">üòé</div>
                    <div class="acc-option" onclick="setAcc('gls', 'üßê')">üßê</div>
                    <div class="acc-option" onclick="setAcc('gls', '')">‚ùå</div>
                </div>
                <div class="wardrobe-sec">
                    <div class="wardrobe-title">BIYIKLAR</div>
                    <div class="acc-option" onclick="setAcc('mus', 'üë®üèª')">üë®üèª</div>
                    <div class="acc-option" onclick="setAcc('mus', 'üßî')">üßî</div>
                    <div class="acc-option" onclick="setAcc('mus', 'ü•∏')">ü•∏</div>
                    <div class="acc-option" onclick="setAcc('mus', '„Ä∞Ô∏è')">„Ä∞Ô∏è</div>
                    <div class="acc-option" onclick="setAcc('mus', '')">‚ùå</div>
                </div>
            </div>
        </div>
        <div id="host-settings" style="display:none">
            <select id="turn-select">
                <option value="2">2 Tur</option><option value="4">4 Tur</option><option value="6" selected>6 Tur</option>
                <option value="8">8 Tur</option><option value="10">10 Tur</option><option value="12">12 Tur</option>
            </select>
            <button class="btn-green" onclick="startGame()">BA≈ûLAT!</button>
        </div>
    </div>

    <div id="scr-game" class="content">
        <div id="timer">20</div>
        <div class="word-box" id="word-display">...</div>
        <input type="text" id="game-input" placeholder="Anladƒ±ƒüƒ±nƒ± bozarak yaz..." disabled oninput="sendTyping()" style="width:70%">
        <button id="send-btn" class="btn-green" onclick="sendTurn()" disabled>G√ñNDER</button>
    </div>

    <div id="scr-final" class="content">
        <h2 id="winner-text">Oylama!</h2>
        <div id="final-results" style="width:100%"></div>
        <button class="btn-green btn-large" id="btn-back-lobby" style="display:none" onclick="hostBackToLobby()">LOBƒ∞YE D√ñN</button>
        <button class="btn-red" onclick="location.reload()" style="margin-top:15px; font-size:0.8rem">OYUNDAN √áIK</button>
    </div>
</div>

<script>
    let peer, connections = [], myId, myNick, players = [], turnIdx = 0, maxTurns = 6, history = [], votes = {}, myVoteIdx = -1;
    let timerInterval, myAcc = {hat:'', gls:'', mus:''}, isHost = false;
    const audioTick = new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3');

    function setup(mode) {
        isHost = mode === 'host';
        myNick = document.getElementById('nick').value || "ƒ∞simsiz";
        const shortId = Math.random().toString(36).substring(2, 6).toUpperCase();
        peer = new Peer(isHost ? shortId : undefined);
        peer.on('open', id => {
            myId = id; document.getElementById('my-id').innerText = id;
            show('scr-lobby'); addBubble(id, myNick, true, myAcc);
            players = [{id, nick: myNick, acc: myAcc}];
            if(isHost) {
                document.getElementById('host-settings').style.display='block';
                peer.on('connection', conn => { connections.push(conn); handleData(conn); });
            } else {
                const conn = peer.connect(document.getElementById('room-id').value.toUpperCase());
                connections = [conn]; handleData(conn);
            }
        });
    }

    function broadcast(data) { connections.forEach(c => { if(c.open) c.send(data); }); }

    function handleData(conn) {
        conn.on('open', () => { if(!isHost) conn.send({type:'join', nick:myNick, id:myId, acc:myAcc}); });
        conn.on('data', d => {
            if(isHost && d.type !== 'sync') broadcast(d); 
            if(d.type === 'join') {
                if(!players.find(p=>p.id===d.id)) { players.push({id:d.id, nick:d.nick, acc:d.acc}); addBubble(d.id, d.nick, false, d.acc); }
                if(isHost) broadcast({type:'list', list:players});
            }
            if(d.type === 'list') {
                d.list.forEach(p => { 
                    if(!players.find(x=>x.id===p.id)) { players.push(p); addBubble(p.id, p.nick, p.id===myId, p.acc); }
                    else { updateBubbleAcc(p.id, p.acc); }
                });
            }
            if(d.type === 'move') { let b = document.getElementById('bub-'+d.id); if(b){ b.style.left=d.x; b.style.top=d.y; }}
            if(d.type === 'acc_update') { updateBubbleAcc(d.id, d.acc); }
            if(d.type === 'sync') {
                turnIdx = d.turnIdx; history = d.history; maxTurns = d.maxTurns; players = d.players;
                if(d.state === 'game') { show('scr-game'); startTurnLogic(d.lastText); }
                if(d.state === 'final') { showResults(); }
                if(d.state === 'lobby') { resetToLobby(); }
            }
            if(d.type === 'play' && isHost) {
                history.push({nick: d.nick, text: d.text}); turnIdx++;
                let state = (turnIdx >= maxTurns) ? 'final' : 'game';
                broadcast({type:'sync', state, turnIdx, history, players, maxTurns, lastText: d.text});
                if(state === 'final') showResults(); else startTurnLogic(d.text);
            }
            if(d.type === 'typing') { 
                let current = players[turnIdx % players.length];
                if(myId !== current.id) document.getElementById('word-display').innerText = d.nick + " bozuyor..."; 
            }
            if(d.type === 'vote_sync') { votes = d.votes; updateVoteDisplay(); }
        });
    }

    function addBubble(id, nick, isMe, acc) {
        if(document.getElementById('bub-'+id)) return;
        const b = document.createElement('div');
        b.id = 'bub-'+id; b.className = 'player-bubble'; b.innerText = nick;
        b.innerHTML += `<div class="acc hat">${acc.hat||''}</div><div class="acc glass">${acc.gls||''}</div><div class="acc mustache">${acc.mus||''}</div>`;
        if(isMe) makeDraggable(b, id);
        document.getElementById('lobby-area').appendChild(b);
    }

    function updateBubbleAcc(id, acc) {
        const b = document.getElementById('bub-'+id);
        if(b) {
            b.querySelector('.hat').innerText = acc.hat || '';
            b.querySelector('.glass').innerText = acc.gls || '';
            b.querySelector('.mustache').innerText = acc.mus || '';
            let p = players.find(x=>x.id===id); if(p) p.acc = acc;
        }
    }

    function makeDraggable(el, id) {
        const area = document.getElementById('lobby-area');
        const move = (e) => {
            const cx = e.touches ? e.touches[0].clientX : e.clientX;
            const cy = e.touches ? e.touches[0].clientY : e.clientY;
            const r = area.getBoundingClientRect();
            let x = cx - r.left - 40, y = cy - r.top - 20;
            if(x < 0) x = 0; if(x > r.width - el.offsetWidth) x = r.width - el.offsetWidth;
            if(y < 0) y = 0; if(y > r.height - el.offsetHeight) y = r.height - el.offsetHeight;
            el.style.left = x+"px"; el.style.top = y+"px";
            broadcast({type:'move', id:id, x:el.style.left, y:el.style.top});
        };
        el.onmousedown = () => document.onmousemove = move;
        el.ontouchstart = () => document.ontouchmove = move;
        document.onmouseup = document.ontouchend = () => { document.onmousemove = null; document.ontouchmove = null; };
    }

    function setAcc(type, val) {
        if(type === 'hat') myAcc.hat = val; else if(type === 'gls') myAcc.gls = val; else myAcc.mus = val;
        updateBubbleAcc(myId, myAcc);
        broadcast({type: 'acc_update', id: myId, acc: myAcc});
    }

    function corruptText(text) {
        const chars = "√¶√ü√∞ƒëƒß≈Ç√∏@#$%&0123456789";
        return text.split(' ').map(w => {
            let wordArr = w.split('');
            return wordArr.map(c => {
                let r = Math.random();
                if(r < 0.15) return chars[Math.floor(Math.random()*chars.length)];
                if(r < 0.25) return String.fromCharCode(c.charCodeAt(0) + Math.floor(Math.random()*3));
                return c;
            }).join('') + (Math.random() < 0.2 ? 'üåÄ' : '');
        }).join(' ');
    }

    function startTurnLogic(lastText) {
        let current = players[turnIdx % players.length];
        const isMyTurn = current.id === myId;
        document.getElementById('game-input').disabled = !isMyTurn;
        document.getElementById('send-btn').disabled = !isMyTurn;
        document.body.classList.remove('panic');
        if(isMyTurn) {
            startTimer(); document.getElementById('game-input').focus();
            document.getElementById('word-display').innerText = turnIdx === 0 ? "ƒ∞lk c√ºmleyi yaz!" : corruptText(lastText);
        } else { 
            clearInterval(timerInterval); 
            document.getElementById('word-display').innerText = current.nick + " bekleniyor..."; 
        }
    }

    function startTimer() {
        let t = 20; document.getElementById('timer').innerText = t;
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            t--; document.getElementById('timer').innerText = t;
            if(t <= 5) { document.body.classList.add('panic'); audioTick.play(); }
            if(t <= 0) { clearInterval(timerInterval); sendTurn(); } // S√ºre bitince otomatik g√∂nder (pass)
        }, 1000);
    }

    function sendTurn() {
        const val = document.getElementById('game-input').value || "...";
        document.getElementById('game-input').value = "";
        if(isHost) {
            history.push({nick: myNick, text: val}); turnIdx++;
            let state = (turnIdx >= maxTurns) ? 'final' : 'game';
            broadcast({type:'sync', state, turnIdx, history, players, maxTurns, lastText: val});
            if(state === 'final') showResults(); else startTurnLogic(val);
        } else connections[0].send({type:'play', text:val, nick: myNick});
    }

    function showResults() { 
        show('scr-final'); 
        updateVoteDisplay(); 
        if(isHost) document.getElementById('btn-back-lobby').style.display = 'block';
    }

    function updateVoteDisplay() {
        const resDiv = document.getElementById('final-results');
        let maxV = 0, winner = '';
        resDiv.innerHTML = history.map((h, i) => {
            if((votes[i]||0) > maxV) { maxV = votes[i]; winner = h.nick; }
            return `<div style="padding:10px; border:2px solid ${myVoteIdx===i?'var(--success)':'#eee'}; margin:5px; border-radius:15px; cursor:pointer; background:white" onclick="castVote(${i})"><b>${h.nick}:</b> ${h.text} <span>üî• ${votes[i]||0}</span></div>`;
        }).join('');
        if(maxV > 0) document.getElementById('winner-text').innerText = "üèÜ KRAL: " + winner;
    }

    function castVote(idx) {
        if(myVoteIdx === idx) { votes[idx]--; myVoteIdx = -1; }
        else { if(myVoteIdx !== -1) votes[myVoteIdx]--; votes[idx] = (votes[idx] || 0) + 1; myVoteIdx = idx; }
        broadcast({type:'vote_sync', votes: votes}); updateVoteDisplay();
    }

    function startGame() {
        const mt = parseInt(document.getElementById('turn-select').value);
        const shuffled = [...players].sort(() => Math.random() - 0.5);
        broadcast({type:'sync', state: 'game', turnIdx: 0, history: [], players: shuffled, maxTurns: mt, lastText: ''});
        turnIdx = 0; history = []; players = shuffled; maxTurns = mt; show('scr-game'); startTurnLogic('');
    }

    function hostBackToLobby() {
        broadcast({type:'sync', state: 'lobby', turnIdx: 0, history: [], players, maxTurns, lastText: ''});
        resetToLobby();
    }

    function resetToLobby() {
        clearInterval(timerInterval);
        turnIdx = 0; history = []; votes = {}; myVoteIdx = -1;
        document.body.classList.remove('panic');
        document.getElementById('game-input').value = "";
        document.getElementById('winner-text').innerText = "Oylama!";
        show('scr-lobby');
    }

    function sendTyping() { broadcast({type:'typing', nick:myNick}); }
    function show(id) { document.querySelectorAll('.content').forEach(c=>c.classList.remove('active')); document.getElementById(id).classList.add('active'); }
</script>
</body>
</html>