<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dil-Boz: Neon Kaos ðŸŒ€</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --neon-pink: #ff00ff; --neon-blue: #00ffff; --neon-purple: #9d00ff; --dark: #0a0a0a; }
        body { 
            background: var(--dark); color: white; font-family: 'Segoe UI', sans-serif; 
            margin: 0; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh;
            background-image: radial-gradient(circle, #1a1a1a 1px, transparent 1px); background-size: 30px 30px;
        }
        
        .panel { 
            background: rgba(20, 20, 20, 0.95); width: 95%; max-width: 700px; height: 90vh; 
            border-radius: 30px; border: 4px solid var(--neon-purple); display: flex; flex-direction: column; 
            box-shadow: 0 0 20px var(--neon-purple), inset 0 0 10px var(--neon-purple); overflow: hidden; 
        }

        .header { 
            background: #000; padding: 20px; font-size: 2.2rem; font-weight: bold; text-align: center; 
            text-shadow: 0 0 10px var(--neon-pink); color: var(--neon-pink); border-bottom: 2px solid var(--neon-pink);
        }

        .content { flex: 1; padding: 20px; display: none; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .content.active { display: flex; }

        /* LOBÄ° & SINIRLANDIRILMIÅž ALAN */
        #lobby-area { 
            width: 100%; height: 350px; background: rgba(0,0,0,0.5); border-radius: 20px; 
            position: relative; margin: 15px 0; border: 2px solid var(--neon-blue); overflow: hidden; 
        }

        .player-bubble { 
            position: absolute; padding: 12px 25px; background: var(--neon-blue); color: #000;
            border-radius: 50px; cursor: grab; font-weight: bold; font-size: 1.1rem; user-select: none;
            box-shadow: 0 0 15px var(--neon-blue); z-index: 100; touch-action: none; 
        }

        /* INPUT & BUTONLAR */
        input { 
            background: #1a1a1a; color: white; border: 2px solid var(--neon-blue); padding: 18px; 
            border-radius: 15px; width: 85%; font-size: 1.1rem; margin-bottom: 10px; box-shadow: inset 0 0 5px var(--neon-blue);
        }
        button { 
            background: var(--neon-purple); color: white; border: none; padding: 15px 35px; 
            border-radius: 15px; cursor: pointer; font-weight: bold; font-size: 1.2rem; transition: 0.2s; 
            box-shadow: 0 0 15px var(--neon-purple); margin: 5px;
        }
        button:hover { transform: scale(1.05); filter: brightness(1.2); }
        button:disabled { background: #444; box-shadow: none; cursor: not-allowed; opacity: 0.5; }

        .word-box { 
            background: #000; padding: 30px; border-radius: 20px; font-size: 2rem; 
            color: #faa61a; font-weight: bold; margin: 15px 0; border: 2px solid var(--neon-pink); 
            text-align: center; width: 90%; box-shadow: 0 0 15px var(--neon-pink);
        }

        .id-badge { color: var(--neon-blue); font-weight: bold; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>

    <div class="panel">
        <div class="header">DÄ°L-BOZ: NEON ðŸŒ€</div>

        <div id="screen-login" class="content active">
            <input type="text" id="input-nick" placeholder="Nick SeÃ§...">
            <button onclick="startMode('host')">Lobi Kur</button>
            <button onclick="startMode('join')" style="background: var(--neon-blue); color: black;">Odaya KatÄ±l</button>
            <input type="text" id="input-room-id" placeholder="Oda Kodunu YapÄ±ÅŸtÄ±r..." style="display:none; margin-top: 15px;">
        </div>

        <div id="screen-lobby" class="content">
            <p>Oda Kodu: <span class="id-badge" id="display-my-id" onclick="copyId()">Kopyala</span></p>
            <div id="lobby-area"></div>
            <p id="status-msg">BaÄŸlantÄ± bekleniyor...</p>
            <button id="btn-start-game" onclick="broadcastStart()" style="display:none;">OYUNU BAÅžLAT âž”</button>
        </div>

        <div id="screen-game" class="content">
            <h3 id="turn-info">Bekleniyor...</h3>
            <div class="word-box" id="game-word">HAZIRLAN...</div>
            <input type="text" id="input-game" placeholder="Buraya yaz..." disabled>
            <button id="btn-send" onclick="sendTurn()" disabled>GÃ–NDER</button>
        </div>
    </div>

    <script>
        let peer, conn, myId, myNick;
        let isHost = false;
        let playerList = []; // KatÄ±lma sÄ±rasÄ±nÄ± tutar
        let currentTurnIndex = 0;
        const charMap = {'a':'Î±','e':'â‚¬','u':'Î¼','Ã¼':'Ï‹','s':'Â§','ÅŸ':'âˆ«','o':'0','Ã¶':'Î¸','i':'Ä±','Ä±':'i','g':'9'};

        function startMode(mode) {
            myNick = document.getElementById('input-nick').value || "Oyuncu";
            if(mode === 'host') { isHost = true; initPeer(); } 
            else { 
                document.getElementById('input-room-id').style.display = 'block';
                let target = document.getElementById('input-room-id').value;
                if(target) initPeer(target);
            }
        }

        function initPeer(targetId = null) {
            peer = new Peer();
            peer.on('open', id => {
                myId = id;
                document.getElementById('display-my-id').innerText = id;
                showScreen('screen-lobby');
                addBubble(id, myNick, true);
                playerList.push({id: id, nick: myNick});
                if(targetId) { conn = peer.connect(targetId); setupConn(); }
            });
            peer.on('connection', c => { conn = c; isHost = true; setupConn(); document.getElementById('btn-start-game').style.display = 'block'; });
        }

        function setupConn() {
            conn.on('open', () => {
                conn.send({type: 'hello', nick: myNick, id: myId});
            });
            conn.on('data', data => {
                if(data.type === 'hello') {
                    addBubble(data.id, data.nick, false);
                    playerList.push({id: data.id, nick: data.nick});
                    if(isHost) conn.send({type: 'hello', nick: myNick, id: myId});
                }
                if(data.type === 'move') updateBubblePos(data.id, data.x, data.y);
                if(data.type === 'start') { showScreen('screen-game'); updateTurnUI(); }
                if(data.type === 'turn') receiveTurn(data.text);
            });
        }

        function addBubble(id, nick, isMe) {
            if(document.getElementById('bub-'+id)) return;
            const b = document.createElement('div');
            b.id = 'bub-' + id;
            b.className = 'player-bubble';
            b.innerText = nick;
            b.style.left = "50px"; b.style.top = "50px";
            if(isMe) { b.style.boxShadow = "0 0 20px white"; makeDraggable(b, id); }
            document.getElementById('lobby-area').appendChild(b);
        }

        // TELEFON VE PC UYUMLU SÃœRÃœKLEME
        function makeDraggable(el, id) {
            const area = document.getElementById('lobby-area');
            const move = (e) => {
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                const rect = area.getBoundingClientRect();
                
                let x = clientX - rect.left - el.offsetWidth / 2;
                let y = clientY - rect.top - el.offsetHeight / 2;

                // SINIRLAR (AlanÄ±n dÄ±ÅŸÄ±na Ã§Ä±kamaz)
                if(x < 0) x = 0; if(x > rect.width - el.offsetWidth) x = rect.width - el.offsetWidth;
                if(y < 0) y = 0; if(y > rect.height - el.offsetHeight) y = rect.height - el.offsetHeight;

                el.style.left = x + "px"; el.style.top = y + "px";
                if(conn) conn.send({type: 'move', id: id, x: el.style.left, y: el.style.top});
            };
            el.addEventListener('mousedown', () => document.addEventListener('mousemove', move));
            el.addEventListener('touchstart', () => document.addEventListener('touchmove', move));
            document.addEventListener('mouseup', () => { document.removeEventListener('mousemove', move); });
            document.addEventListener('touchend', () => { document.removeEventListener('touchmove', move); });
        }

        function updateBubblePos(id, x, y) {
            const b = document.getElementById('bub-'+id);
            if(b) { b.style.left = x; b.style.top = y; }
        }

        function broadcastStart() { conn.send({type: 'start'}); showScreen('screen-game'); updateTurnUI(); }

        function updateTurnUI() {
            let currentPlayer = playerList[currentTurnIndex % playerList.length];
            document.getElementById('turn-info').innerText = "SÄ±ra: " + currentPlayer.nick;
            
            if(currentPlayer.id === myId) {
                document.getElementById('input-game').disabled = false;
                document.getElementById('btn-send').disabled = false;
                document.getElementById('turn-info').style.color = "var(--neon-blue)";
            } else {
                document.getElementById('input-game').disabled = true;
                document.getElementById('btn-send').disabled = true;
                document.getElementById('turn-info').style.color = "white";
                document.getElementById('game-word').innerText = "ArkadaÅŸÄ±n yazÄ±yor...";
            }
        }

        function sendTurn() {
            let txt = document.getElementById('input-game').value;
            if(!txt) return;
            conn.send({type: 'turn', text: txt});
            currentTurnIndex++;
            document.getElementById('input-game').value = "";
            updateTurnUI();
        }

        function receiveTurn(txt) {
            let corrupted = txt.split('').map(c => (charMap[c.toLowerCase()] && Math.random() > 0.4) ? charMap[c.toLowerCase()] : c).join('');
            document.getElementById('game-word').innerText = corrupted;
            currentTurnIndex++;
            updateTurnUI();
        }

        function showScreen(id) {
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function copyId() { navigator.clipboard.writeText(myId); alert("Kod kopyalandÄ±!"); }
    </script>
</body>
</html>