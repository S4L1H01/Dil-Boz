<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DÄ°L-BOZ | Kaos BaÅŸlasÄ±n!</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg: #F0F4F8;
            --primary: #6E7BFF;
            --secondary: #FF85A1;
            --accent: #FFD166;
            --text: #2D3436;
        }

        body { 
            background: var(--bg);
            margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex; justify-content: center; align-items: center; height: 100vh;
            color: var(--text);
        }

        /* GARTIC TARZI ARKA PLAN */
        .bg-pattern {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #e5e5f7;
            opacity: 0.4;
            background-image:  radial-gradient(#6e7bff 0.5px, transparent 0.5px), radial-gradient(#6e7bff 0.5px, #e5e5f7 0.5px);
            background-size: 20px 20px;
            background-position: 0 0,10px 10px;
            z-index: -1;
        }

        .panel { 
            background: white; width: 95%; max-width: 600px; min-height: 80vh; 
            border-radius: 40px; border: 12px solid white; display: flex; flex-direction: column; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1); position: relative;
        }

        .header { 
            padding: 20px; background: var(--primary); color: white; 
            text-align: center; font-size: 2rem; font-weight: bold;
            border-radius: 25px 25px 5px 5px; letter-spacing: 2px;
        }

        .content { flex: 1; padding: 25px; display: none; flex-direction: column; align-items: center; justify-content: flex-start; }
        .active { display: flex; }
        
        /* LOBÄ° ALANI */
        #lobby-area { 
            width: 100%; height: 300px; background: #F8FAFC; border-radius: 30px; 
            position: relative; margin: 20px 0; border: 4px dashed #CBD5E1; overflow: hidden; 
        }

        .player-bubble { 
            position: absolute; padding: 12px 20px; background: var(--secondary); color: white; 
            border-radius: 50px; cursor: grab; font-weight: bold; border: 3px solid white; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: transform 0.2s;
            user-select: none; touch-action: none;
        }

        /* INPUT & BUTTONS */
        input { 
            padding: 15px; border-radius: 20px; border: 3px solid #E2E8F0; 
            width: 80%; margin-bottom: 15px; font-size: 1.1rem; outline: none; transition: 0.3s;
        }
        input:focus { border-color: var(--primary); }

        button { 
            padding: 15px 35px; border-radius: 20px; border: none; cursor: pointer; 
            font-weight: bold; color: white; font-size: 1.1rem; transition: 0.3s;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }
        button:active { transform: translateY(3px); box-shadow: none; }
        
        .btn-green { background: #00B894; }
        .btn-blue { background: var(--primary); }
        .btn-red { background: #FF7675; }

        /* GAMEPLAY */
        #timer { font-size: 2rem; font-weight: bold; color: var(--secondary); margin-bottom: 10px; }
        .word-box { 
            background: #F1F2F6; padding: 30px; border-radius: 25px; 
            font-size: 1.4rem; color: #2D3436; border: 4px solid var(--accent); 
            width: 85%; text-align: center; margin-bottom: 20px; min-height: 60px;
        }

        /* OYLAMA SÄ°STEMÄ° */
        .res-item { 
            background: white; margin: 10px 0; padding: 15px; border-radius: 20px; 
            border: 3px solid #F1F2F6; width: 90%; display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: 0.3s;
        }
        .res-item:hover { border-color: var(--secondary); transform: scale(1.02); }
        .vote-count { background: var(--accent); padding: 5px 12px; border-radius: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div class="bg-pattern"></div>

<div class="panel">
    <div class="header" id="game-header">DÄ°L-BOZ ðŸŒ€</div>

    <div id="scr-login" class="content active">
        <input type="text" id="nick" placeholder="Takma AdÄ±n...">
        <button class="btn-green" onclick="setup('host')">Oda Kur</button>
        <button class="btn-blue" style="margin-top:10px" onclick="document.getElementById('join-box').style.display='block'">Odaya KatÄ±l</button>
        <div id="join-box" style="display:none; width:100%; text-align:center; margin-top:20px;">
            <input type="text" id="room-id" placeholder="Kod Buraya...">
            <button class="btn-blue" onclick="setup('join')">GiriÅŸ Yap</button>
        </div>
    </div>

    <div id="scr-lobby" class="content">
        <p style="margin:0">Oda Kodu (TÄ±kla Kopyala):</p>
        <h2 id="my-id" style="color:var(--primary); cursor:pointer; margin: 10px 0;">...</h2>
        <div id="lobby-area"></div>
        <button id="start-btn" class="btn-green" style="display:none" onclick="startGame()">OYUNU BAÅžLAT!</button>
    </div>

    <div id="scr-game" class="content">
        <div id="timer">20</div>
        <h3 id="turn-msg">SÄ±ra Bekleniyor...</h3>
        <div class="word-box" id="word-display">...</div>
        <input type="text" id="game-input" placeholder="GÃ¶rdÃ¼ÄŸÃ¼nÃ¼ yorumla..." disabled oninput="sendTyping()">
        <button id="send-btn" class="btn-green" onclick="sendTurn()" disabled>GÃ–NDER</button>
    </div>

    <div id="scr-final" class="content">
        <h2>Hangi CÃ¼mle Daha SaÃ§ma? ðŸŽ¨</h2>
        <p>En komiÄŸine oy ver!</p>
        <div id="final-results" style="width: 100%; display: flex; flex-direction: column; align-items: center;"></div>
        <button class="btn-red" style="margin-top:20px" onclick="location.reload()">Yeni Oyun</button>
    </div>
</div>

<script>
    let peer, conn, myId, myNick, players = [], turnIdx = 0, maxTurns = 5, history = [], votes = {};
    let timerInterval;
    const foreign = ['Table', 'Zimmer', 'Bonjour', 'Karpuz', 'Space', 'Mesa', 'Baklava', 'Computer'];
    const charMap = {'a':'4','e':'3','i':'1','o':'0','s':'5','ÅŸ':'âˆ«','u':'Î¼','Ã¼':'Ï‹','Ã¶':'Î¸'};

    // SETUP & P2P
    function setup(mode) {
        myNick = document.getElementById('nick').value || "Oyuncu" + Math.floor(Math.random()*100);
        const shortId = Math.random().toString(36).substring(2, 6).toUpperCase();
        peer = new Peer(mode === 'host' ? shortId : undefined);

        peer.on('open', id => {
            myId = id; 
            document.getElementById('my-id').innerText = id;
            document.getElementById('my-id').onclick = () => {
                navigator.clipboard.writeText(id);
                alert("Kod kopyalandÄ±!");
            };
            show('scr-lobby'); 
            addBubble(id, myNick, true);
            players.push({id: id, nick: myNick});
            if(mode === 'join') {
                const target = document.getElementById('room-id').value.toUpperCase();
                conn = peer.connect(target);
                handleConn();
            }
        });

        peer.on('connection', c => { 
            conn = c; 
            handleConn(); 
            document.getElementById('start-btn').style.display='block'; 
        });
    }

    function handleConn() {
        conn.on('open', () => conn.send({type:'join', nick:myNick, id:myId}));
        conn.on('data', d => {
            if(d.type === 'join') { 
                players.push({id:d.id, nick:d.nick}); 
                addBubble(d.id, d.nick, false);
                if(players.length > 1) conn.send({type:'list', list:players});
            }
            if(d.type === 'list') { 
                d.list.forEach(p => { if(!players.find(x=>x.id==p.id)) { players.push(p); addBubble(p.id, p.nick, false); }}); 
            }
            if(d.type === 'move') { 
                let b = document.getElementById('bub-'+d.id); 
                if(b){ b.style.left=d.x; b.style.top=d.y; } 
            }
            if(d.type === 'start') { players = d.players; show('scr-game'); startTurnLogic(); }
            if(d.type === 'play') { history.push({nick: d.nick, text: d.text}); receiveTurn(d.text); }
            if(d.type === 'typing') { document.getElementById('word-display').innerText = d.nick + " yazÄ±yor..."; }
            if(d.type === 'finish') { history = d.history; showResults(); }
            if(d.type === 'vote') { votes[d.idx] = (votes[d.idx] || 0) + 1; updateVoteDisplay(); }
        });
    }

    // LOBÄ° BALONCUKLARI
    function addBubble(id, nick, isMe) {
        if(document.getElementById('bub-'+id)) return;
        const b = document.createElement('div');
        b.id = 'bub-'+id; b.className = 'player-bubble'; b.innerText = nick;
        b.style.left = Math.random()*150 + "px"; b.style.top = Math.random()*150 + "px";
        if(isMe) makeDraggable(b, id);
        document.getElementById('lobby-area').appendChild(b);
    }

    function makeDraggable(el, id) {
        const area = document.getElementById('lobby-area');
        const move = (e) => {
            const cx = e.touches ? e.touches[0].clientX : e.clientX;
            const cy = e.touches ? e.touches[0].clientY : e.clientY;
            const r = area.getBoundingClientRect();
            let x = cx - r.left - 40, y = cy - r.top - 20;
            el.style.left = x+"px"; el.style.top = y+"px";
            if(conn) conn.send({type:'move', id:id, x:el.style.left, y:el.style.top});
        };
        el.addEventListener('mousedown', () => document.addEventListener('mousemove', move));
        el.addEventListener('touchstart', () => document.addEventListener('touchmove', move));
        document.addEventListener('mouseup', () => document.removeEventListener('mousemove', move));
        document.addEventListener('touchend', () => document.removeEventListener('touchmove', move));
    }

    // OYUN MANTIÄžI
    function startGame() {
        players.sort(() => Math.random() - 0.5);
        conn.send({type:'start', players:players});
        show('scr-game'); startTurnLogic();
    }

    function startTimer() {
        let timeLeft = 20;
        document.getElementById('timer').innerText = timeLeft;
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeLeft--;
            document.getElementById('timer').innerText = timeLeft;
            if(timeLeft <= 0) {
                clearInterval(timerInterval);
                if(!document.getElementById('game-input').disabled) sendTurn();
            }
        }, 1000);
    }

    function startTurnLogic() {
        if(turnIdx >= maxTurns) {
            if(conn) conn.send({type:'finish', history: history});
            showResults(); return;
        }
        let current = players[turnIdx % players.length];
        const isMyTurn = current.id === myId;
        
        document.getElementById('turn-msg').innerText = isMyTurn ? "SIRA SENDE! Ã‡ABUK YAZ!" : current.nick + " DÃœÅžÃœNÃœYOR...";
        document.getElementById('game-input').disabled = !isMyTurn;
        document.getElementById('send-btn').disabled = !isMyTurn;
        
        if(isMyTurn) {
            startTimer();
            document.getElementById('game-input').focus();
        } else {
            clearInterval(timerInterval);
        }
    }

    function sendTyping() { if(conn) conn.send({type:'typing', nick:myNick}); }

    function sendTurn() {
        const val = document.getElementById('game-input').value || "BoÅŸ bÄ±raktÄ±!";
        history.push({nick: myNick, text: val});
        if(conn) conn.send({type:'play', text:val, nick: myNick});
        document.getElementById('game-input').value = "";
        turnIdx++; startTurnLogic();
    }

    function receiveTurn(t) {
        let corruption = 0.4;
        let words = t.split(' ').map(w => {
            if(Math.random() < 0.2) return foreign[Math.floor(Math.random()*foreign.length)];
            return w.split('').map(c => (charMap[c.toLowerCase()] && Math.random() < 0.5) ? charMap[c.toLowerCase()] : c).join('');
        }).join(' ');
        
        document.getElementById('word-display').innerText = words;
        turnIdx++; startTurnLogic();
    }

    // OYLAMA SÄ°STEMÄ°
    function showResults() {
        show('scr-final');
        updateVoteDisplay();
    }

    function updateVoteDisplay() {
        const resDiv = document.getElementById('final-results');
        resDiv.innerHTML = history.map((h, i) => `
            <div class="res-item" onclick="castVote(${i})">
                <span><b>${h.nick}:</b> ${h.text}</span>
                <span class="vote-count">ðŸ”¥ ${votes[i] || 0}</span>
            </div>
        `).join('');
    }

    function castVote(idx) {
        votes[idx] = (votes[idx] || 0) + 1;
        if(conn) conn.send({type:'vote', idx: idx});
        updateVoteDisplay();
    }

    function show(id) { 
        document.querySelectorAll('.content').forEach(c=>c.classList.remove('active')); 
        document.getElementById(id).classList.add('active'); 
    }
</script>
</body>
</html>